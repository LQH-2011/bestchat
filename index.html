<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="msvalidate.01" content="B0B322327165D8A53D973F6ECA048996" />
    <title>Chat Interface</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 600px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        h3 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        address {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .key-input {
            width: 100%;
            max-width: 600px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        input {
            width: 100%;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        button.clear {
            background-color: #f44336;
            float: center;
        }
        button.clear:hover {
            background-color: #d32f2f;
        }
        button.new-key {
            background-color: #2196F3;
            float: center;
            margin-right: 10px;
        }
        button.new-key:hover {
            background-color: #0b7dda;
        }
        .chat-container {
            display: none;
        }
        .chat-box {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 4px;
            background-color: #e9e9e9;
        }
        .message-header {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        .message-time {
            font-size: 0.8em;
            color: #888;
        }
        .input-area {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .name-input {
            flex: 1;
            min-width: 150px;
        }
        .message-input {
            flex: 2;
            min-width: 200px;
        }
        .send-btn {
            flex: 0 0 auto;
        }
    </style>
</head>
<body>
    <div class="key-input" id="keyInput">
        <h1>Enter Your TextDB Key</h1>
        <p>Please enter your textdb.online key to continue</p>
        <p>(If you don't know what this is, then just type in something you can remember, preferrably longer to avoid collision. For more, see <a href="https://textdb.online">here</a>)</p>
        <input type="text" id="apiKey" placeholder="Enter your TextDB key (6-60 characters)" pattern="[0-9a-zA-Z\-_]{6,60}" required>
        <button id="saveKey">Save Key</button>
        <p style="font-size: 0.9em; color: #666; margin-top: 15px;">
            The key must be 6-60 characters long and can only contain: 0-9, a-z, A-Z, -, _
        </p>
    </div>

    <div class="container chat-container" id="chatContainer">
        <h1>Best Chat</h1>
        <h3>This site is powered by <a href="https://textdb.online">textdb.online</a></h3>
        <p style="text-align:center;">You are the<span><img src="https://w.saobby.com/w/itcldvic"></span>th visitor!</p>
        <address>By <a href="https://bgithub.xyz/LQH-2011">LQH-2011</a></address>
        <button class="clear" id="clearBtn">Clear All Chats</button>
        <button class="new-key" id="newKeyBtn">Enter New Key</button>
        <div class="chat-box" id="chatBox">
            <!-- Chat messages will appear here -->
        </div>
        <div class="input-area">
            <input type="text" class="name-input" id="nameInput" placeholder="Your Name">
            <input type="text" class="message-input" id="messageInput" placeholder="Type your message...">
            <button class="send-btn" id="sendBtn">Send</button>
        </div>
    </div>

    <script>
        // DOM elements
        const keyInputDiv = document.getElementById('keyInput');
        const chatContainerDiv = document.getElementById('chatContainer');
        const apiKeyInput = document.getElementById('apiKey');
        const saveKeyBtn = document.getElementById('saveKey');
        const chatBox = document.getElementById('chatBox');
        const nameInput = document.getElementById('nameInput');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const clearBtn = document.getElementById('clearBtn');
        const newKeyBtn = document.getElementById('newKeyBtn');

        // API configuration
        const API_URL = 'https://textdb.online/update/';
        let currentKey = '';

        // Check if we already have a key in localStorage
        window.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('textdbKey');
            if (savedKey) {
                currentKey = savedKey;
                apiKeyInput.value = savedKey;
                showChatInterface();
                loadChats();
            }
        });

        // Save key button click handler
        saveKeyBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key && /^[0-9a-zA-Z\-_]{6,60}$/.test(key)) {
                currentKey = key;
                localStorage.setItem('textdbKey', key);
                showChatInterface();
                loadChats();
            } else {
                alert('Please enter a valid key (6-60 characters, only 0-9, a-z, A-Z, -, _ allowed)');
            }
        });

        // New key button click handler
        newKeyBtn.addEventListener('click', () => {
            keyInputDiv.style.display = 'block';
            chatContainerDiv.style.display = 'none';
        });

        // Show chat interface and hide key input
        function showChatInterface() {
            keyInputDiv.style.display = 'none';
            chatContainerDiv.style.display = 'block';
        }

        // Load chats from textdb.online
        async function loadChats() {
            try {
                const response = await fetch(`https://textdb.online/${currentKey}`);
                if (response.ok) {
                    const data = await response.text();
                    if (data) {
                        const chats = JSON.parse(data);
                        displayChats(chats);
                    } else {
                        chatBox.innerHTML = '<div class="message">No messages yet. Start the conversation!</div>';
                    }
                } else {
                    console.error('Failed to load chats');
                    chatBox.innerHTML = '<div class="message">Failed to load messages.</div>';
                }
            } catch (error) {
                console.error('Error loading chats:', error);
                chatBox.innerHTML = '<div class="message">Error loading messages.</div>';
            }
        }

        // Display chats in the chat box
        function displayChats(chats) {
            chatBox.innerHTML = '';
            if (chats.length === 0) {
                chatBox.innerHTML = '<div class="message">No messages yet. Start the conversation!</div>';
                return;
            }
            
            chats.forEach(chat => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = `
                    <div class="message-header">${escapeHtml(chat.name)}</div>
                    <div>${escapeHtml(chat.message)}</div>
                    <div class="message-time">${chat.timestamp}</div>
                `;
                chatBox.appendChild(messageDiv);
            });
            
            // Scroll to the bottom
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Send message
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const name = nameInput.value.trim();
            const message = messageInput.value.trim();
            
            if (!name) {
                alert('Please enter your name');
                return;
            }
            
            if (!message) {
                alert('Please enter a message');
                return;
            }
            
            // Get existing chats
            let chats = [];
            try {
                const response = await fetch(`https://textdb.online/${currentKey}`);
                if (response.ok) {
                    const data = await response.text();
                    if (data) {
                        chats = JSON.parse(data);
                    }
                }
            } catch (error) {
                console.error('Error loading existing chats:', error);
            }
            
            // Add new message
            const timestamp = new Date().toLocaleString();
            chats.push({
                name: name,
                message: message,
                timestamp: timestamp
            });
            
            // Update on textdb.online
            try {
                const response = await fetch(`https://api.textdb.online/update/?key=${currentKey}&value=${encodeURIComponent(JSON.stringify(chats))}`);
                
                const result = await response.json();
                if (result.status === 1) {
                    // Success
                    messageInput.value = '';
                    displayChats(chats);
                } else {
                    alert('Failed to send message. Please try again.');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message. Please try again.');
            }
        }

        // Clear all chats
        clearBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all chats? This action cannot be undone.')) {
                clearAllChats();
            }
        });

        async function clearAllChats() {
            try {
                const response = await fetch(`https://api.textdb.online/update/?key=${currentKey}&value=`);
                
                const result = await response.json();
                if (result.status === 1) {
                    // Success
                    chatBox.innerHTML = '<div class="message">No messages yet. Start the conversation!</div>';
                } else {
                    alert('Failed to clear chats. Please try again.');
                }
            } catch (error) {
                console.error('Error clearing chats:', error);
                alert('Error clearing chats. Please try again.');
            }
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
